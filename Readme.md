# mini-redis-go
Лёгкая реализация in-memory key-value хранилища, совместимого с протоколом RESP (Redis Serialization Protocol).  
Проект создан в образовательных целях для изучения сетевого взаимодействия, протоколов и архитектуры серверов на Go.

## Возможности
- Поддержка RESP-протокола (работает с `redis-cli`)
- Команды:
  - `PING` → `+PONG`
  - `ECHO <msg>` → возвращает сообщение
  - `SET <key> <value>` → сохранить значение
  - `GET <key>` → получить значение
  - `DEL <key>` → удалить ключ
- Поддержка TTL (истечение ключей)
- Простое логирование (`internal/logx`)
- Конфигурация сервера (`internal/config`)

## Архитектура
```bash
cmd/
 └── miniredis/        # Точка входа
internal/
 ├── server/           # TCP-сервер, роутер команд
 ├── resp/             # Парсер и сериализатор RESP
 ├── store/            # In-memory хранилище (с TTL)
 ├── logx/             # Единый логгер
 └── config/           # Конфигурация приложения
tests/
 └── e2e_*_test.go     # E2E-тесты работы сервера
```

## Запуск
В одном терминале запустите сервер:
```bash
make run
# или
go run cmd/miniredis/main.go
```

Во втором терминале подключитесь к порту запущенного сервера через `redis-cli`:
```bash
redis-cli -p 6381
```

## Проверка команд

Подключившись через `redis-cli`, можно проверить работу всех реализованных команд:

**Базовые команды:**
```bash
127.0.0.1:6381> PING                # Проверка соединения
PONG
127.0.0.1:6381> ECHO Hello User     # Эхо-сообщение
"Hello User"
```
**Работа с ключами:**
```bash
127.0.0.1:6381> SET name1 anton     # Установка значения
OK
127.0.0.1:6381> GET name1           # Получение значения
"anton"
127.0.0.1:6381> DEL name1           # Удаление ключа
(integer) 1
```
**Множественные ключи:**
```bash
127.0.0.1:6381> SET name1 anton
OK
127.0.0.1:6381> SET name2 artem
OK
127.0.0.1:6381> MGET name1 name2    # Получение нескольких значений
1) "anton"
2) "artem"
```
**TTL и время жизни:**
```bash
127.0.0.1:6381> EXPIRE name1 10     # Установить срок жизни в 10 секунд
(integer) 1
127.0.0.1:6381> TTL name1           # Проверить оставшееся время
(integer) 10
127.0.0.1:6381> GET name1           # После истечения срока — nil
(nil)
```

## Тестирование

Чтобы протестировать: необходимо остановить сервер - в обоих терминалах graceful shutdown (Ctrl+C);
Запустить как 
```bash 
make run &
```
- Unit-тесты для модулей `resp/` и `store/`
- E2E-тесты для серверных команд

```bash
make test
# или
go test ./... -v
```

После проверки тестов необходимо выйти из сервера так:
```bash
lsof -i :6381   # узнаём PID
kill <PID>      # останавливаем сервер (вместо <PID> - номер)
```

---

## Технические детали

- **Concurrency (параллельность)**  
  Каждый клиент обрабатывается в отдельной goroutine.  
  Сервер слушает TCP-порт и для каждого входящего соединения создаёт отдельный поток обработки:  
  `go s.handleConnection(conn)`  
  Это позволяет одновременно обслуживать несколько клиентов.

- **Безопасность доступа к данным**  
  В `internal/store` используется `sync.Mutex` для защиты общей `map[string]Value`.  
  Благодаря этому операции `SET`, `GET`, `DEL` потокобезопасны при обращении из разных клиентов.

- **TTL-механизм (истечение ключей)**  
  Реализован через фоновую горутину-сканер (`StartTTLScanner`), которая раз в секунду проходит по хранилищу  
  и удаляет ключи с истекшим временем жизни.  
  Это упрощённый аналог поведения настоящего Redis.

- **Протокол RESP (Redis Serialization Protocol)**  
  Модуль `internal/resp` реализует чтение (`Reader`) и запись (`Writer`) RESP-сообщений.  
  Поддерживаются типы:
  - Simple String (`+OK\r\n`)
  - Error (`-ERR ...\r\n`)
  - Integer (`:1\r\n`)
  - Bulk String (`$5\r\nhello\r\n`)
  - Array (`*2\r\n$4\r\nECHO\r\n$5\r\nhello\r\n`)

- **Роутер команд**  
  В `internal/server/router.go` реализован маршрутизатор, который сопоставляет команду  
  с её обработчиком (`PING`, `ECHO`, `SET`, `GET`, `DEL`, `EXPIRE`, `TTL`, `MGET`).

- **Логирование**  
  Используется собственный пакет `logx` — минималистичная обёртка над стандартным `log`  
  с единым форматированием сообщений (`[INFO]`, `[ERROR]`, и т.д.).

- **Конфигурация**  
  Пакет `config` хранит параметры запуска (порт, таймауты, уровень логирования)  
  и подставляет дефолтные значения при отсутствии внешних конфигов.

- **Семафоры и ограничения клиентов (в перспективе)**  
  В структуре `Server` предусмотрено поле `maxClients`.  
  Оно может быть использовано для реализации семафора, ограничивающего  
  число одновременно подключённых клиентов.


## Цель проекта
Проект создан для практики:
- сетевого программирования (TCP, goroutines)
- парсинга протоколов (RESP)
- проектирования многослойной архитектуры Go-приложений 
- тестирования (unit + e2e)

---

## Автор
Антон Радченко - Go-Developer

GitHub: [AntonRadchenko](https://github.com/AntonRadchenko)